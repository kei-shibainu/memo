# 03_DB設計メモ
## 論理設計のアンチパターン
+ 非スカラ値
    + 配列型による非スカラ値
    + 論理的な非スカラ値(姓名など)。極力分割して保持する。分割は難儀で結合は容易だからである。
+ ダブルミーニング。特定の列に二つ以上の意味を持たせる。
+ 単一参照テーブル。マスタテーブルを作成し、コードテーブルを纏める。
    + コードタイプ、コード値、コードの内容という形で保持する。
    + 各属性はコードタイプに応じて値が変動するため大きめの可変超文字列で定義が必要
    + コードタイプやコード値の閾値に誤りがあっても気づくことができない
    + コード列とデータ型が異なる可能性があるため外部キーに指定できない。
+ テーブル分割
    + 水平分割。テーブルのレコード数が肥大化した場合にテーブルを分割する
        + 正規化の概念ではない。
        + 拡張性に乏しい。次月以降もテーブルを増やす必要がありアプリの改修が必要。
        + 標準でパーティション機能が存在する。
    + 垂直分割。特定の列のみ検索条件とすることが判明している場合チューニングの用途で列を分割する。
        + 正規化の概念ではない。
        + 代替方法に集約がある。
            + 列の絞り込み。保持する列を絞ったテーブルを作成する。このような小規模なテーブルをデータマートと呼ぶ。  
            + サマリテーブル。集約関数でレコードを集約した状態で作成する。
            + 上記は複数の列に同じ情報をもつため同期のタイミングに注意する必要がある。
+ ダブルマスタ。マスタ情報を複数のテーブルに持つ。システム統廃合時に発生することがある。
+ ゾンビマートと多段マート
    + 画像や動画、音声を一元的に管理して分析用途に利用することをデータレイクという
    + データマートはユーザからの要請で気軽につくられるため不要になったテーブル群が発生することがある。
    + 不要になったテーブル削除してよいのか分からないため削除できないケースがある。これをゾンビマートと呼ぶ。
    + データをいくつかの段階に分けて保存する方法を多段マートと呼ぶ。
    + 階層的にマートをわけデータを格納するとデータの推移が追いづらくまた整合性にも問題が生じる恐れがある。

### 論理設計のグレーノウハウ
+ 代理キー
    + 以下のように自然キーを定められないケースがある
        + 入力データに一意キーが存在しない
        + 一意キーはあるが、サイクリック(循環的)に使いまわされる
        + 一意キーはあるが、途中で指す対象が変化する
    + 代理キーは論理的な意味合いが薄いため、極力自然キーを使用することが望ましい
    + 下二つの要素はタイムスタンプまたはインターバルの列を追加することで解消することも可能
    + 代理キーを使用する場合はシーケンス、IDなどのオートナンバリングを利用する。 
    + シーケンスとIDはRDBMS毎に実装が異なるため可能な限りシーケンスを利用する。
+ 列持ちテーブル
    + 列で繰り返しを表現することを列持ちテーブルと呼ぶ。
    + 基本的には枝番列をもった行持ちテーブルを使用すべきである。
+ アドホック(一時的)な集計キー
    + 県を地方に結びつけるときに一時的に地方コードを列として加える。
    + サイズの大きいテーブルに付与するとパフォーマンスの面で落ちたりする。
    + 以下のような解決策をとる
        + アドホックなキーを別テーブルに分離する
        + ビューを作成する
        + case文などで検索時に分類する
+ 多段ビュー
    + ビューは利用者からするとテーブルと同じように扱えるが、内部的にはデータを持たずアクセス時にセレクト文を発行する。
    + 多段的なビュー構造にするとビュー間や基底テーブルのアクセスというようにアクセスパスが増えるためパフォーマンスが落ちる。
+ データクレンジング
    + 業務で利用されているデータをデータベースに登録できるように綺麗にすることをデータクレンジングと呼ぶ。
    + まずは一意キーの作成を実施する。その際似たような名前を統合するための名寄せをおこなう。
    + 名寄せは住所や電話番号などである程度機械的に実施し、最終的には人間の目で確認する。

## 一歩進んだ論理設計
+ 隣接リストモデル
    + 木構造を扱うモデルの一つ。ノードのレコードに親ノードのレコードを持つもの。
    + 例を出すと社員列と上司列を持つテーブルなどである。
    + 再帰的な構造であるため昔はアンチパターンとされていたが、再帰共通表式をDBMSがサポートするようになり、今では新たに着目されている。
+ 閉包テーブルモデル
    + 木構造を扱うモデルの一つ。親と子を持つテーブルを作成するのが特徴。
+ 筆者の意見では参照整合性制約を付与できるため隣接リストモデルを採用するのがベスト。

## 参考
[達人に学ぶDB設計徹底指南書 第2版](https://www.amazon.co.jp/dp/B0D8N5G9GT)